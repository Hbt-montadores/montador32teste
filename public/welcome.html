<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo! - Montador de Sermões 3.2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    
    <script src="pwa-installer.js" defer></script>
</head>
<body>
    <header>
        <img src="https://cdn.glitch.global/db74bd9b-d683-421c-9223-f55b917c9dce/logo.png?v=1734385573934" alt="Logo do Montador de Sermões 3.2" class="logo">
    </header>
    
    <div class="welcome-container">
        <h1 id="welcome-title">Parabéns!</h1>
        <p id="welcome-text">Seja bem-vindo ao Montador de Sermões 3.2. Para a melhor experiência, recomendamos instalar o atalho do aplicativo em seu dispositivo.</p>
        
        <button id="install-button" class="start-button">Começar a Usar</button>
        <button id="notifications-button" class="start-button" style="display: none;">Ativar Notificações</button>

    </div>

    <script>
        // Versão Definitiva com verificação imediata do prompt

        const installButton = document.getElementById('install-button');
        const notificationsButton = document.getElementById('notifications-button');
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeText = document.getElementById('welcome-text');

        let isInstallable = false;

        function onAppInstallable() {
            if (isInstallable) return; // Evita rodar duas vezes
            console.log('[welcome] App é instalável. Atualizando botão 1.');
            isInstallable = true;
            installButton.innerText = 'Instalar App';
        }
        
        // Ouve por futuras oportunidades de instalação
        window.addEventListener('pwa-installable', onAppInstallable);
        
        // ADIÇÃO CRÍTICA: Verifica imediatamente se o prompt já foi capturado na página anterior
        if (window.deferredPrompt) {
            onAppInstallable();
        }

        function showNotificationsStep() {
            installButton.style.display = 'none';
            if (('serviceWorker' in navigator) && ('PushManager' in window) && (Notification.permission === 'default')) {
                notificationsButton.style.display = 'block';
                welcomeTitle.innerText = 'Último Passo!';
                welcomeText.innerText = 'Clique abaixo para receber atualizações importantes e novidades do Montador de Sermões.';
                notificationsButton.innerText = 'Ativar';
            } else {
                redirectToApp();
            }
        }

        function redirectToApp() {
            window.location.href = '/app';
        }

        installButton.addEventListener('click', async () => {
            if (isInstallable && window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    window.deferredPrompt = null;
                }
            }
            showNotificationsStep();
        });

        notificationsButton.addEventListener('click', async () => {
            try {
                const permissionResult = await Notification.requestPermission();
                if (permissionResult === 'granted') {
                    await subscribeUserToPush();
                }
            } catch (error) {
                console.error('[welcome] Erro ao pedir permissão de notificação:', error);
            } finally {
                redirectToApp();
            }
        });

        async function subscribeUserToPush() {
            try {
                const registration = await navigator.serviceWorker.ready;
                const VAPID_PUBLIC_KEY_RESPONSE = await fetch('/api/vapid-public-key');
                if (!VAPID_PUBLIC_KEY_RESPONSE.ok) throw new Error('Falha ao buscar chave VAPID.');
                const VAPID_PUBLIC_KEY = await VAPID_PUBLIC_KEY_RESPONSE.text();
                if (!VAPID_PUBLIC_KEY) throw new Error('Chave VAPID vazia.');
                const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
                await fetch('/api/subscribe-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription),
                });
            } catch (error) {
                console.error('[welcome] Falha ao inscrever para notificações:', error);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
</body>
</html>
