<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo! - Montador de Sermões 3.2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    
    <script src="pwa-installer.js" defer></script>
</head>
<body>
    <header>
        <img src="https://cdn.glitch.global/db74bd9b-d683-421c-9223-f55b917c9dce/logo.png?v=1734385573934" alt="Logo do Montador de Sermões 3.2" class="logo">
    </header>
    
    <div class="welcome-container">
        <h1>Parabéns!</h1>
        <p>Seja bem-vindo ao Montador de Sermões 3.2. Para a melhor experiência, recomendamos instalar o atalho do aplicativo em seu dispositivo.</p>
        
        <button id="start-button" class="start-button">Começar a Usar</button>
    </div>

    <script>
        // Lógica final e robusta para instalação e redirecionamento

        const startButton = document.getElementById('start-button');
        const defaultText = 'Começar a Usar';
        const installText = 'Instalar e Começar';

        // Função para atualizar o botão quando o app for instalável
        function updateButtonToInstall() {
            console.log('[welcome.html] Atualizando botão para modo de instalação.');
            startButton.innerText = installText;
        }
        
        // Ouve o evento customizado disparado pelo pwa-installer.js
        // Esta é a forma robusta de saber que o app é instalável.
        window.addEventListener('pwa-installable', updateButtonToInstall);

        startButton.addEventListener('click', async () => {
            // Verifica a variável global no momento do clique.
            if (window.deferredPrompt) {
                console.log('[welcome.html] Botão de instalação clicado. Mostrando prompt...');
                window.deferredPrompt.prompt();
                
                const { outcome } = await window.deferredPrompt.userChoice;
                
                console.log(`[welcome.html] Resultado da instalação: ${outcome}`);
                
                // Limpa a referência para que o evento não seja usado novamente.
                window.deferredPrompt = null;
                
                // Se a instalação foi concluída com sucesso ou dispensada,
                // esperamos um pouco antes de redirecionar para dar tempo de a UI do SO fechar.
                if (outcome === 'accepted' || outcome === 'dismissed') {
                    setTimeout(() => {
                        window.location.href = '/app';
                    }, 500); // Meio segundo de espera
                    return; // Impede o redirecionamento imediato abaixo
                }
            }
            
            // Se não houver prompt para mostrar, redireciona imediatamente.
            console.log('[welcome.html] Nenhum prompt de instalação disponível. Redirecionando para /app.');
            window.location.href = '/app';
        });
    </script>
</body>
</html>
