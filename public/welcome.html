<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bem-vindo! - Montador de Sermões 3.2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    
    <!-- Este script é crucial. Ele captura o prompt de instalação em QUALQUER página -->
    <script src="pwa-installer.js" defer></script>
</head>
<body>
    <header>
        <img src="https://cdn.glitch.global/db74bd9b-d683-421c-9223-f55b917c9dce/logo.png?v=1734385573934" alt="Logo do Montador de Sermões 3.2" class="logo">
    </header>
    
    <div class="welcome-container">
        <h1 id="welcome-title">Parabéns!</h1>
        <p id="welcome-text">Seja bem-vindo ao Montador de Sermões 3.2. Para a melhor experiência, recomendamos instalar o atalho do aplicativo em seu dispositivo.</p>
        
        <!-- Botão Único de Ação. O texto dele mudará dinamicamente. -->
        <button id="action-button" class="start-button">Começar a Usar</button>

    </div>

    <script>
        // Lógica final, robusta, baseada no clique do usuário e no estado das permissões.

        const actionButton = document.getElementById('action-button');
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeText = document.getElementById('welcome-text');

        let currentStep = 'start'; // Os passos podem ser: 'start', 'install', 'notify', 'redirect'

        // Função que decide o que fazer a seguir, baseada no estado atual
        async function nextStep() {
            console.log(`[Welcome] Iniciando nextStep. Passo atual: ${currentStep}`);

            // === PASSO DE INSTALAÇÃO ===
            // A variável window.deferredPrompt é preenchida pelo pwa-installer.js (se o navegador permitir)
            if (window.deferredPrompt) {
                console.log('[Welcome] Prompt de instalação encontrado. Mostrando...');
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                console.log(`[Welcome] Resultado da instalação: ${outcome}`);
                
                if (outcome === 'accepted') {
                    window.deferredPrompt = null; // Limpa o prompt pois foi usado
                }
                // Após a interação (aceita ou não), vamos para o passo de notificação
                showNotificationStep();
                return;
            }

            // === PASSO DE NOTIFICAÇÃO ===
            // Se chegamos aqui, ou não havia prompt de instalação, ou ele já foi tratado.
            // Agora verificamos se as notificações são possíveis e ainda não foram permitidas.
            if (('PushManager' in window) && (Notification.permission === 'default')) {
                console.log('[Welcome] Mostrando passo de notificação.');
                showNotificationStep();
                return;
            }

            // === PASSO DE REDIRECIONAMENTO ===
            // Se não há instalação para oferecer E não há notificações para pedir, vamos direto ao app.
            console.log('[Welcome] Nada a pedir. Redirecionando para /app.');
            redirectToApp();
        }

        // Função que muda a UI para a etapa de notificação
        function showNotificationStep() {
            welcomeTitle.innerText = 'Último Passo!';
            welcomeText.innerText = 'Clique abaixo para receber atualizações importantes e novidades do Montador de Sermões.';
            actionButton.innerText = 'Ativar Notificações';
            currentStep = 'notify'; // Muda o estado do botão
        }

        function redirectToApp() {
            window.location.href = '/app';
        }

        // Ouve o clique PRINCIPAL no botão de ação
        actionButton.addEventListener('click', async () => {
            if (currentStep === 'start' || currentStep === 'install') {
                // Na primeira vez que clicamos, verificamos a instalação primeiro.
                await nextStep();
            } else if (currentStep === 'notify') {
                // Se o botão foi clicado quando estava no modo "Ativar Notificações"
                console.log('[Welcome] Solicitando permissão de notificação...');
                try {
                    const permissionResult = await Notification.requestPermission();
                    console.log(`[Welcome] Resultado da permissão: ${permissionResult}`);
                    if (permissionResult === 'granted') {
                        await subscribeUserToPush(); // Tenta inscrever
                    }
                } catch (error) {
                    console.error('[Welcome] Erro ao pedir permissão de notificação:', error);
                } finally {
                    redirectToApp(); // Redireciona independente do resultado
                }
            }
        });
        
        // --- Funções de Suporte para Notificação ---

        async function subscribeUserToPush() {
            try {
                const registration = await navigator.serviceWorker.ready;
                const VAPID_PUBLIC_KEY_RESPONSE = await fetch('/api/vapid-public-key');
                if (!VAPID_PUBLIC_KEY_RESPONSE.ok) throw new Error('Falha ao buscar chave VAPID.');
                const VAPID_PUBLIC_KEY = await VAPID_PUBLIC_KEY_RESPONSE.text();
                if (!VAPID_PUBLIC_KEY) throw new Error('Chave VAPID vazia.');
                const applicationServerKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
                await fetch('/api/subscribe-push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription),
                });
                console.log('[Welcome] Inscrição Push enviada com sucesso.');
            } catch (error) {
                console.error('[Welcome] Falha ao inscrever para notificações:', error);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // VERIFICAÇÃO INICIAL:
        // Assim que a página carrega, vamos verificar se o app já é instalável.
        // Se for, mudamos o texto do botão imediatamente.
        window.addEventListener('load', () => {
            // Damos um pequeno delay para o pwa-installer.js (carregado via 'defer') ter tempo de rodar.
            setTimeout(() => {
                if (window.deferredPrompt) {
                    console.log('[Welcome] Prompt de instalação detectado no carregamento.');
                    actionButton.innerText = 'Instalar App';
                    currentStep = 'install';
                } else {
                    console.log('[Welcome] Nenhum prompt de instalação detectado no carregamento.');
                }
            }, 500); // 500ms é um tempo seguro de espera.
        });
        
    </script>
</body>
</html>
